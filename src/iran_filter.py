import logging

logger = logging.getLogger(__name__)

IR = [
    "2.144.","2.145.","2.146.","2.147.","2.176.","2.177.","2.178.","2.179.",
    "2.180.","2.181.","2.182.","2.183.","2.184.","2.185.","2.186.","2.187.",
    "5.1.","5.22.","5.23.","5.52.","5.53.","5.56.","5.57.","5.58.","5.59.",
    "5.61.","5.62.","5.63.","5.72.","5.74.","5.75.","5.104.","5.106.",
    "5.112.","5.113.","5.114.","5.115.","5.116.","5.117.","5.118.","5.119.",
    "5.120.","5.121.","5.122.","5.123.","5.124.","5.125.","5.126.","5.127.",
    "5.160.","5.161.","5.162.","5.163.","5.200.","5.201.","5.202.","5.203.",
    "5.208.","5.209.","5.210.","5.211.","5.212.","5.213.","5.214.","5.215.",
    "5.232.","5.233.","5.234.","5.235.","5.236.","5.237.","5.238.","5.239.",
    "31.2.","31.3.","31.7.","31.14.","31.24.","31.25.","31.40.","31.41.",
    "31.56.","31.57.",
    "37.9.","37.10.","37.19.","37.32.","37.33.","37.34.","37.35.","37.36.",
    "37.37.","37.38.","37.39.","37.44.","37.49.","37.63.","37.98.","37.99.",
    "37.114.","37.129.","37.130.","37.137.","37.138.","37.143.","37.148.",
    "37.152.","37.153.","37.154.","37.155.","37.156.","37.191.","37.202.",
    "37.228.","37.235.","37.254.","37.255.",
    "46.21.","46.34.","46.36.","46.41.","46.51.","46.62.","46.100.",
    "46.143.","46.148.","46.164.","46.167.","46.209.","46.224.","46.225.",
    "46.235.","46.245.","46.248.","46.249.","46.251.",
    "62.3.","62.32.","62.60.","62.102.","62.133.","62.193.","62.220.",
    "66.79.","69.194.",
    "77.36.","77.42.","77.81.","77.95.","77.104.","77.237.","77.238.",
    "78.31.","78.38.","78.39.","78.110.","78.111.","78.154.","78.157.","78.158.",
    "79.127.","79.132.","79.143.","79.174.","79.175.",
    "80.66.","80.71.","80.75.","80.191.","80.210.","80.242.","80.249.","80.253.",
    "81.12.","81.16.","81.28.","81.29.","81.31.","81.32.","81.33.",
    "81.90.","81.91.","81.92.",
    "82.97.","82.99.","82.138.","82.180.",
    "83.120.","83.121.","83.122.","83.123.","83.147.",
    "84.47.","84.241.",
    "85.9.","85.15.","85.133.","85.185.","85.198.","85.204.","85.208.",
    "86.55.","86.57.","86.104.","86.105.","86.106.","86.107.","86.109.",
    "87.107.","87.236.","87.247.","87.248.",
    "89.32.","89.33.","89.34.","89.35.","89.36.","89.37.","89.38.","89.39.",
    "89.42.","89.43.","89.165.","89.196.","89.219.","89.235.",
    "91.92.","91.98.","91.99.","91.107.","91.108.","91.133.","91.147.",
    "91.184.","91.185.","91.186.","91.187.","91.188.","91.189.","91.190.",
    "91.191.","91.208.","91.209.","91.210.","91.211.","91.212.","91.213.",
    "91.214.","91.215.","91.216.","91.217.","91.218.","91.219.","91.220.",
    "91.221.","91.222.","91.223.","91.224.","91.225.","91.226.","91.227.",
    "91.228.","91.229.","91.230.","91.231.","91.232.","91.233.","91.234.",
    "91.235.","91.236.","91.237.","91.238.","91.239.","91.240.","91.241.",
    "91.242.","91.243.","91.244.","91.245.","91.246.","91.247.","91.248.",
    "91.249.","91.250.","91.251.",
    "92.42.","92.43.","92.61.","92.114.","92.119.","92.242.","92.246.",
    "93.88.","93.110.","93.113.","93.114.","93.115.","93.117.","93.118.",
    "93.119.","93.126.","93.190.",
    "94.24.","94.74.","94.101.","94.139.","94.176.","94.177.","94.182.",
    "94.183.","94.184.","94.199.",
    "95.38.","95.64.","95.80.","95.81.","95.130.","95.142.","95.143.",
    "95.156.","95.162.",
    "109.70.","109.110.","109.122.","109.125.","109.162.","109.201.",
    "109.203.","109.230.","109.238.",
    "113.203.","128.65.","130.185.","130.244.",
    "151.232.","151.238.","151.239.","151.240.","151.241.","151.242.",
    "151.243.","151.244.","151.245.","151.246.","151.247.","151.248.",
    "151.249.","151.250.","151.251.","151.252.","151.253.","151.254.","151.255.",
    "152.89.","158.58.","159.20.","164.138.","164.215.",
    "176.12.","176.56.","176.62.","176.65.","176.101.","176.102.","176.103.",
    "176.116.","176.122.","176.124.","176.126.","176.221.","176.223.",
    "178.21.","178.22.","178.131.","178.157.","178.169.","178.173.",
    "178.215.","178.216.","178.219.","178.220.","178.236.","178.238.",
    "178.239.","178.248.","178.252.",
    "185.1.","185.2.","185.3.","185.4.","185.5.","185.8.","185.10.",
    "185.11.","185.12.","185.13.","185.14.","185.15.","185.16.","185.17.",
    "185.18.","185.19.","185.20.","185.21.","185.22.","185.23.","185.24.",
    "185.25.","185.26.","185.27.","185.28.","185.29.","185.30.","185.31.",
    "185.32.","185.33.","185.34.","185.36.","185.37.","185.39.","185.40.",
    "185.41.","185.42.","185.44.","185.45.","185.46.","185.47.","185.49.",
    "185.50.","185.51.","185.53.","185.55.","185.56.","185.57.","185.58.",
    "185.59.","185.60.","185.72.","185.73.","185.74.","185.75.","185.76.",
    "185.78.","185.79.","185.80.","185.81.","185.82.","185.83.","185.84.",
    "185.85.","185.86.","185.88.","185.92.","185.94.","185.95.","185.96.",
    "185.97.","185.98.","185.100.","185.101.","185.103.","185.104.","185.105.",
    "185.106.","185.107.","185.108.","185.109.","185.110.","185.112.","185.113.",
    "185.114.","185.115.","185.116.","185.117.","185.118.","185.119.","185.120.",
    "185.121.","185.122.","185.123.","185.124.","185.125.","185.126.","185.128.",
    "185.129.","185.130.","185.131.","185.132.","185.133.","185.134.","185.135.",
    "185.136.","185.137.","185.139.","185.140.","185.141.","185.142.","185.143.",
    "185.144.","185.145.","185.146.","185.147.","185.148.","185.149.","185.150.",
    "185.151.","185.152.","185.153.","185.154.","185.155.","185.156.","185.157.",
    "185.158.","185.159.","185.160.","185.161.","185.162.","185.163.","185.164.",
    "185.165.","185.166.","185.167.","185.168.","185.169.","185.170.","185.171.",
    "185.172.","185.173.","185.174.","185.175.","185.176.","185.177.","185.178.",
    "185.179.","185.180.","185.181.","185.182.","185.183.","185.184.","185.185.",
    "185.186.","185.187.","185.188.","185.189.","185.190.","185.191.","185.192.",
    "185.193.","185.194.","185.195.","185.196.","185.197.","185.198.","185.199.",
    "185.200.","185.201.","185.202.","185.203.","185.204.","185.205.","185.206.",
    "185.207.","185.208.","185.209.","185.210.","185.211.","185.212.","185.213.",
    "185.214.","185.215.","185.216.","185.217.","185.218.","185.219.","185.220.",
    "185.221.","185.222.","185.223.","185.224.","185.225.","185.226.","185.227.",
    "185.228.","185.229.","185.230.","185.231.","185.232.","185.233.","185.234.",
    "185.235.","185.236.","185.237.","185.238.",
    "188.0.","188.75.","188.121.","188.122.","188.136.","188.158.","188.159.",
    "188.174.","188.208.","188.209.","188.210.","188.211.","188.212.","188.213.",
    "188.214.","188.215.","188.229.","188.230.","188.231.","188.232.","188.233.",
    "188.237.","188.238.","188.240.","188.253.",
    "193.0.","193.3.","193.8.","193.19.","193.22.","193.24.","193.29.",
    "193.32.","193.34.","193.35.","193.36.","193.37.","193.38.","193.39.",
    "193.41.","193.56.","193.111.","193.141.","193.142.","193.151.","193.176.",
    "193.178.","193.186.","193.200.","193.201.","193.222.","193.228.","193.242.",
    "194.5.","194.9.","194.26.","194.33.","194.36.","194.41.","194.48.",
    "194.50.","194.53.","194.56.","194.59.","194.60.","194.62.","194.143.",
    "194.146.","194.147.","194.150.","194.225.",
    "195.2.","195.8.","195.28.","195.88.","195.110.","195.146.","195.181.",
    "195.190.","195.191.","195.211.","195.214.","195.225.","195.226.",
    "195.234.","195.241.",
    "212.1.","212.16.","212.18.","212.23.","212.33.","212.56.","212.73.",
    "212.80.","212.86.","212.120.","212.151.",
    "213.41.","213.109.","213.176.","213.195.","213.207.","213.217.",
    "213.232.","213.233.",
    "217.11.","217.24.","217.25.","217.60.","217.66.","217.77.","217.144.",
    "217.146.","217.161.","217.170.","217.171.","217.172.","217.174.",
    "217.218.","217.219.",
]

# Build set for O(1) lookup
_IR_SET = set(IR)


def is_iran(ip):
    if not ip or not ip[0].isdigit():
        return False
    parts = ip.split(".")
    if len(parts) < 2:
        return False
    # Check x.y.
    key = parts[0] + "." + parts[1] + "."
    return key in _IR_SET


def filter_iran(configs):
    clean = []
    removed = 0
    for c in configs:
        # Only check if address is IP, skip hostnames
        if c.address and c.address[0].isdigit():
            if is_iran(c.address):
                removed += 1
                continue
        clean.append(c)
    logger.info("Iran filter: removed " + str(removed) + " | kept " + str(len(clean)))
    return clean
